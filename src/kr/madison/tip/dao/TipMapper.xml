<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Tip">
	<select id="findFoodTotalCnt" parameterType="TipVO" resultType="int">
		SELECT
			COUNT(*)
		FROM brd_extratips a
		LEFT JOIN cod_extratips b ON a.tipid = b.tipid
		LEFT JOIN info_userinfo c ON a.userno = c.userno
		WHERE b.ptypeid = 6
		<if test="keyword != null and keyword != ''">
			<if test="srchType == 1">
				AND a.title LIKE CONCAT('%',#{keyword},'%')
			</if>
			<if test="srchType == 2">
				AND c.nickname LIKE CONCAT('%',#{keyword},'%')
			</if>
		</if>
		<if test="tipid != null and tipid != 0">
			<if test="srchType == 3">
				AND a.tipid = #{tipid}
			</if>
		</if>
	</select>
	<select id="getFoodCount" parameterType="TipVO" resultType="int">
		SELECT
			COUNT(*)
		FROM brd_extratips
	</select>
 	<select id="findFoodList" parameterType="TipVO" resultType="TipVO">
		SELECT
			b.brdid,
			b.tipid,
			d.name as typename,
			b.title,
			CASE WHEN b.regdate > CURDATE()
				THEN DATE_FORMAT(b.regdate, '%H:%i:%s')
				ELSE DATE_FORMAT(b.regdate, '%Y-%m-%d')
			END as regdate,
			a.nickname as writer,
			b.count,
			(SELECT COUNT(*) FROM brd_extratips_likes c WHERE b.brdid = c.brdid AND c.likes = 1) as likes,
			(SELECT COUNT(*) FROM brd_extratips_reply c WHERE c.brdid = b.brdid) as repcount
		FROM brd_extratips b
		LEFT JOIN info_userinfo a on b.userno = a.userno
		LEFT JOIN cod_extratips d on b.tipid = d.tipid	
		WHERE  d.ptypeid = 6
		
		<if test="keyword != null and keyword != ''">
			<if test="srchType == 1">
				AND b.title LIKE CONCAT('%',#{keyword},'%')
			</if>
			<if test="srchType == 2">
				AND a.nickname LIKE CONCAT('%',#{keyword},'%')
			</if>
		</if>
		ORDER BY b.brdid DESC
		LIMIT #{skiprow}, #{pagerow}
		<!-- LIMIT #{srow}, #{rows} -->
	</select>
	<select id="findFoodContent" parameterType="TipVO"
		resultType="TipVO">
		SELECT
			b.brdid,
			b.tipid,
			d.name as typename,
			b.title,
			DATE_FORMAT(b.regdate, '%Y-%m-%d %H:%i:%s') as regdate,
			b.content,
			a.nickname as writer,
			b.userno,
			b.count,
			(SELECT COUNT(*) FROM brd_extratips_likes c WHERE b.brdid = c.brdid AND c.likes = 1) as likes,
			(SELECT COUNT(*) FROM brd_extratips_likes c WHERE b.brdid = c.brdid AND c.dislikes = 1) as dislikes
		FROM brd_extratips b
		LEFT JOIN info_userinfo a on b.userno = a.userno
		LEFT JOIN cod_extratips d on b.tipid = d.tipid
		WHERE b.brdid = #{brdid}
	</select>

	<insert id="addFoodData" parameterType="TipVO" useGeneratedKeys="true" keyProperty="brdid" keyColumn="brdid">
		INSERT INTO brd_extratips(
			tipid,
			title,
			regdate,
			moddate,
			content,
			userno	
		) VALUES(
			#{tipid},
         	#{title},
         	NOW(),
         	NOW(),
         	#{content},
         	#{userno}		
		)
		<selectKey keyProperty="brdid" resultType="int" order="AFTER">
         	SELECT LAST_INSERT_ID()
      	</selectKey>
	</insert>
	<insert id="addFoodReply" parameterType="TipVO" useGeneratedKeys="true" keyProperty="repid" keyColumn="repid">
		INSERT INTO brd_extratips_reply(
			brdid,
			content,
			regdate,
			moddate,
			userno
		)VALUES(
			#{brdid},
			#{repContent},
			NOW(),
			NOW(),
			#{userno}
		)
		<selectKey keyProperty="repid" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	<update id="modFoodCount" parameterType="TipVO">
		UPDATE brd_extratips SET
			count = count + 1
		WHERE brdid = #{brdid}
	</update>
	<select id="checkLikes" parameterType="TipVO" resultType="TipVO">
		SELECT
			id as lid,
			likes,
			dislikes
		FROM brd_extratips_likes
		WHERE userno = #{userno}
			AND brdid = #{brdid}
	</select>
	<insert id="addFoodLikes" parameterType="TipVO">
		INSERT INTO brd_extratips_likes(
			brdid,
			userno,
			likes,
			dislikes
		)VALUES(
			#{brdid},
			#{userno},
			#{likes},
			#{dislikes}
		)
	</insert>
	<update id="modFoodLikes" parameterType="TipVO">
		UPDATE brd_extratips_likes SET
			likes = likes + 1
		WHERE brdid = #{brdid}
			AND userno = #{userno}
	</update>
	<update id="modFoodDislikes" parameterType="TipVO">
		UPDATE brd_extratips_likes SET
			dislikes = dislikes + 1
		WHERE brdid = #{brdid}
			AND userno = #{userno}
	</update>
	<select id="checkRepLikes" parameterType="TipVO" resultType="TipVO">
		SELECT
			id as replid,
			likes as repLikes,
			dislikes as repDislikes
		FROM brd_extratips_reply_likes
		WHERE userno = #{userno}
			AND repid = #{repid}
	</select>
	<insert id="addFoodRepLikes" parameterType="TipVO">
		INSERT INTO brd_extratips_reply_likes(
			repid,
			userno,
			likes,
			dislikes
		)VALUES(
			#{repid},
			#{userno},
			#{repLikes},
			#{repDislikes}
		)
	</insert>
	<update id="modRepLikes" parameterType="TipVO">
		UPDATE brd_extratips_reply_likes SET
			likes = likes + 1
		WHERE repid = #{repid}
			AND userno = #{userno}
	</update>
	<update id="modRepDisLikes" parameterType="TipVO">
		UPDATE brd_extratips_reply_likes SET
			dislikes = dislikes + 1
		WHERE repid = #{repid}
			AND userno = #{userno}
	</update>
	<select id="getReplyCount" parameterType="TipVO" resultType="int">
		SELECT
			COUNT(*)
		FROM brd_extratips_reply
		WHERE brdid = #{brdid}
	</select>
	<select id="findFoodReply" parameterType="TipVO" resultType="TipVO">
		SELECT
			a.repid,
			b.nickname as replier,
			a.content as repContent,
			DATE_FORMAT(a.regdate, '%Y-%m-%d %H:%i:%s') as repRegdate,
			(SELECT COUNT(*) FROM brd_extratips_reply_likes c WHERE a.repid = c.repid AND c.likes = 1) as repLikes,
			(SELECT COUNT(*) FROM brd_extratips_reply_likes c WHERE a.repid = c.repid AND c.dislikes = 1) as repDislikes
		FROM brd_extratips_reply a
		LEFT JOIN info_userinfo b on a.userno = b.userno
		WHERE a.brdid = #{brdid}
	</select>
	<update id="modFoodData" parameterType="TipVO">
		UPDATE brd_extratips SET
			content = #{content},
			title = #{title},
			moddate = NOW(),
			tipid = #{tipid}
		WHERE brdid = #{brdid}
	</update>

	<select id="findMarketTotalCnt" parameterType="TipVO" resultType="int">
		SELECT
			COUNT(*)
		FROM brd_extratips a
		LEFT JOIN cod_extratips b ON a.tipid = b.tipid
		WHERE b.tipid = 2
	</select>
	<select id="getMarketCount" parameterType="TipVO" resultType="int">
		SELECT
			COUNT(*)
		FROM brd_extratips
		
	</select>
 	<select id="findMarketList" parameterType="TipVO" resultType="TipVO">
		SELECT
			b.brdid,
			b.tipid,
			d.name as typename,
			b.title,
			CASE WHEN b.regdate > CURDATE()
				THEN DATE_FORMAT(b.regdate, '%H:%i:%s')
				ELSE DATE_FORMAT(b.regdate, '%Y-%m-%d')
			END as regdate,
			a.nickname as writer,
			b.count,
			b.likes,
			(SELECT COUNT(*) FROM brd_extratips_reply c WHERE c.brdid = b.brdid) as repcount
		FROM brd_extratips b
		LEFT JOIN info_userinfo a on b.userno = a.userno
		LEFT JOIN cod_extratips d on b.tipid = d.tipid
		WHERE d.ptypeid=7
		<if test="keyword != null and keyword != ''">
			<if test="srchType == 1">
				AND b.title LIKE CONCAT('%',#{keyword},'%')
			</if>
			<if test="srchType == 2">
				AND a.nickname LIKE CONCAT('%',#{keyword},'%')
			</if>
		</if>
		ORDER BY b.brdid DESC
		LIMIT #{skiprow}, #{pagerow}
		<!-- LIMIT #{srow}, #{rows} -->
	</select>
	<select id="findMarketContent" parameterType="TipVO"
		resultType="TipVO">
		SELECT
			b.brdid,
			b.tipid,
			d.name as typename,
			b.title,
			DATE_FORMAT(b.regdate, '%Y-%m-%d %H:%i:%s') as regdate,
			b.content,
			a.nickname as writer,
			b.userno,
			b.count,
			b.likes,
			b.dislikes
			<!-- File 셀렉트 하는것 필요 -->
		FROM brd_extratips b
		LEFT JOIN info_userinfo a on b.userno = a.userno
		LEFT JOIN cod_extratips d on b.tipid = d.tipid
		WHERE b.brdid = #{brdid}
	</select>

	<insert id="addMarketData" parameterType="TipVO" useGeneratedKeys="true" keyProperty="brdid" keyColumn="brdid">
		INSERT INTO brd_extratips(
			tipid,
			title,
			regdate,
			moddate,
			content,
			userno	
		) VALUES(
			#{tipid},
         	#{title},
         	NOW(),
         	NOW(),
         	#{content},
         	#{userno}		
		)
		<selectKey keyProperty="brdid" resultType="int" order="AFTER">
         	SELECT LAST_INSERT_ID()
      	</selectKey>
		
	</insert>
	
	<insert id="addMarketReply" parameterType="TipVO" useGeneratedKeys="true" keyProperty="repid" keyColumn="repid">
		INSERT INTO brd_extratips_reply(
			brdid,
			content,
			regdate,
			moddate,
			userno
		)VALUES(
			#{brdid},
			#{repContent},
			NOW(),
			NOW(),
			#{userno}
		)
		<selectKey keyProperty="repid" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	<update id="modMarketCount" parameterType="TipVO">
		UPDATE brd_extratips SET
			count = count + 1
		WHERE brdid = #{brdid}
	</update>
	<update id="modMarketLikes" parameterType="TipVO">
		UPDATE brd_extratips SET
			likes = likes + 1
		WHERE brdid = #{brdid}
	</update>
	<update id="modMarketDislikes" parameterType="TipVO">
		UPDATE brd_extratips SET
			dislikes = dislikes + 1
		WHERE brdid = #{brdid}
	</update>
	<update id="modMarketRepLikes" parameterType="TipVO">
		UPDATE brd_extratips_reply SET
			likes = likes + 1
		WHERE repid = #{repid}
	</update>
	<update id="modMarketRepDisLikes" parameterType="TipVO">
		UPDATE brd_extratips_reply SET
			dislikes = dislikes + 1
		WHERE repid = #{repid}
	</update>
	<select id="getMarketReplyCount" parameterType="TipVO" resultType="int">
		SELECT
			COUNT(*)
		FROM brd_extratips_reply
		WHERE brdid = #{brdid}
	</select>
	<select id="findMarketReply" parameterType="TipVO" resultType="TipVO">
		SELECT
			a.repid,
			b.nickname as replier,
			a.content as repContent,
			DATE_FORMAT(a.regdate, '%Y-%m-%d %H:%i:%s') as repRegdate,
			(SELECT COUNT(*) FROM brd_extratips_reply_likes c WHERE a.repid = c.repid AND c.likes = 1) as repLikes,
			(SELECT COUNT(*) FROM brd_extratips_reply_likes c WHERE a.repid = c.repid AND c.dislikes = 1) as repDislikes
		FROM brd_extratips_reply a
		LEFT JOIN info_userinfo b on a.userno = b.userno
		WHERE a.brdid = #{brdid}
	</select>
	<update id="modMarketData" parameterType="TipVO">
		UPDATE brd_extratips SET
			content = #{content},
			title = #{title},
			moddate = NOW(),
			tipid = #{tipid}
		WHERE brdid = #{brdid}
	</update>
	
	<select id="getFrtypes" parameterType="TipVO" resultType="TipVO">
		SELECT
			tipid,
			name as typename
		FROM cod_extratips
		WHERE ptypeid = 6
		
	</select>
	
	<select id="getMarketFrtypes" parameterType="TipVO" resultType="TipVO">
		SELECT
			tipid,
			name as typename
		FROM cod_extratips
		WHERE ptypeid = 7
		
	</select>
	<delete id="delBoardData" parameterType="TipVO">
		DELETE FROM brd_extratips
			WHERE brdid = #{brdid}
	</delete>
	<delete id="delBoardReplyData" parameterType="TipVO">
		DELETE FROM brd_extratips_reply
			WHERE brdid = #{brdid}
		<if test="repid != null and repid != ''">
			AND repid = #{repid}
		</if>
	</delete>
	<delete id="delBoardLikes" parameterType="TipVO">
		DELETE FROM brd_extratips_likes
			WHERE brdid = #{brdid}
	</delete>
	<delete id="delBoardReplyLikes" parameterType="TipVO">
		DELETE FROM brd_extratips_reply_likes
			WHERE repid in (SELECT a.repid FROM brd_extratips_reply a WHERE a.brdid = #{brdid})
	</delete>
</mapper>