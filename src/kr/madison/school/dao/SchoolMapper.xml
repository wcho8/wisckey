<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="School">
	<!--일단 족보  -->
	<select id="findPastWorkList" parameterType="SchoolVO" resultType="SchoolVO">
		SELECT
			b.brdid,
			b.swid,
			b.title,
			CASE WHEN b.regdate > CURDATE()
				THEN DATE_FORMAT(b.regdate, '%H:%i:%s')
				ELSE DATE_FORMAT(b.regdate, '%Y-%m-%d')
			END as regdate,
			a.nickname as writer,
			b.count,
			b.likes,
			(SELECT COUNT(*) FROM brd_schoolwork_reply c WHERE c.brdid = b.brdid) as repcount
		FROM brd_schoolwork b
		LEFT JOIN info_userinfo a on b.userno = a.userno
		WHERE swid=1
		<if test = "keyword != null and keyword !=''">
			<if test = "srchType ==1">
				AND b.title LIKE CONCAT('%',#{keyword},'%')
			</if>
			<if test = "srchType ==2">
				AND a.nickname LIKE CONCAT('%', #{keyword}, '%')
			</if>
		</if>
		ORDER BY b.brdid DESC
		LIMIT #{skiprow}, #{pagerow}
	</select>
	<insert id="addPastWorkData" parameterType="SchoolVO" useGeneratedKeys="true" keyProperty="brdid" keyColumn="brdid">
		INSERT INTO brd_schoolwork(
			swid,
			title,
			regdate,
			moddate,
			content,
			userno
		) VALUES(
			#{swid},
			#{title},
			NOW(),
			NOW(),
			#{content},
			#{userno}
		)
		<selectKey keyProperty="brdid" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	<select id="findPastWorkContent" parameterType="SchoolVO" resultType="SchoolVO">
		SELECT
			b.brdid,
			b.swid,
			b.title,
			DATE_FORMAT(b.regdate, '%Y-%m-%d %H:%i:%s') as regdate,
			b.content,
			a.nickname as writer,
			b.userno,
			b.count,
			b.likes
		FROM brd_schoolwork b
		LEFT JOIN info_userinfo a on b.userno = a.userno
		WHERE b.brdid = #{brdid}
	</select>
	<update id="modPastWorkCount" parameterType="SchoolVO">
		UPDATE brd_schoolwork SET
			count = count + 1
		WHERE brdid = #{brdid}
	</update>
	<select id="findPastWorkTotalCnt" parameterType="SchoolVO" resultType="int">
		SELECT 
			COUNT(*)
		FROM brd_schoolwork
		WHERE swid=1
	</select>
	<insert id="addPastWorkReply" parameterType="SchoolVO" useGeneratedKeys="true" keyProperty="repid" keyColumn="repid">
		INSERT INTO brd_schoolwork_reply(
			brdid,
			content,
			regdate,
			moddate,
			userno
		) VALUES(
			#{brdid},
			#{repContent},
			NOW(),
			NOW(),
			#{userno}
		)
		<selectKey keyProperty="repid" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>	
	<select id="findPastWorkReply" parameterType="SchoolVO"  resultType="SchoolVO">
		SELECT 
			a.repid,
			b.nickname as replier,
			a.content as repContent,
			DATE_FORMAT(a.regdate, '%Y-%m-%d %H:%i:%s') as repRegdate
		FROM brd_schoolwork_reply a
		LEFT JOIN info_userinfo b on a.userno = b.userno
		WHERE a.brdid = #{brdid}
	</select>
	<delete id="deletePastWorkReply" parameterType="SchoolVO">
		DELETE FROM
			brd_schoolwork_reply
		WHERE brdid = #{brdid}
	</delete>
	<delete id="deletePastWork" parameterType="SchoolVO">
		DELETE FROM
			brd_schoolwork
		WHERE brdid=#{brdid}
	</delete>
	<update id="modPastWorkData" parameterType="SchoolVO">
		UPDATE brd_schoolwork SET
			content = #{content},
			title = #{title},
			moddate = NOW()
		WHERE brdid=#{brdid}
	</update>
	
	
	
	
	<!-- 학업게시판 -->
	<select id="findEducationList" parameterType="SchoolVO" resultType="SchoolVO">
		SELECT
			b.brdid,
			b.swid,
			b.title,
			CASE WHEN b.regdate > CURDATE()
				THEN DATE_FORMAT(b.regdate, '%H:%i:%s')
				ELSE DATE_FORMAT(b.regdate, '%Y-%m-%d')
			END as regdate,
			a.nickname as writer,
			b.count,
			b.likes,
			(SELECT COUNT(*) FROM brd_schoolwork_reply c WHERE c.brdid = b.brdid) as repcount
		FROM brd_schoolwork b
		LEFT JOIN info_userinfo a on b.userno = a.userno
		WHERE swid=2
		<if test = "keyword != null and keyword !=''">
			<if test = "srchType ==1">
				AND b.title LIKE CONCAT('%',#{keyword},'%')
			</if>
			<if test = "srchType ==2">
				AND a.nickname LIKE CONCAT('%', #{keyword}, '%')
			</if>
		</if>
		ORDER BY b.brdid DESC
		LIMIT #{skiprow}, #{pagerow}
	</select>
	<insert id="addEducationData" parameterType="SchoolVO" useGeneratedKeys="true" keyProperty="brdid" keyColumn="brdid">
		INSERT INTO brd_schoolwork(
			swid,
			title,
			regdate,
			moddate,
			content,
			userno
		) VALUES(
			#{swid},
			#{title},
			NOW(),
			NOW(),
			#{content},
			#{userno}
		)
		<selectKey keyProperty="brdid" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	<select id="findEducationContent" parameterType="SchoolVO" resultType="SchoolVO">
		SELECT
			b.brdid,
			b.swid,
			b.title,
			DATE_FORMAT(b.regdate, '%Y-%m-%d %H:%i:%s') as regdate,
			b.content,
			a.nickname as writer,
			b.userno,
			b.count,
			b.likes,
			b.dislikes
		FROM brd_schoolwork b
		LEFT JOIN info_userinfo a on b.userno = a.userno
		WHERE b.brdid = #{brdid}
	</select>
	<update id="modEducationCount" parameterType="SchoolVO">
		UPDATE brd_schoolwork SET
			count = count + 1
		WHERE brdid = #{brdid}
	</update>
	<select id="findEducationTotalCnt" parameterType="SchoolVO" resultType="int">
		SELECT 
			COUNT(*)
		FROM brd_schoolwork
		WHERE swid=2
	</select>
	<insert id="addEducationReply" parameterType="SchoolVO" useGeneratedKeys="true" keyProperty="repid" keyColumn="repid">
		INSERT INTO brd_schoolwork_reply(
			brdid,
			content,
			regdate,
			moddate,
			userno
		) VALUES(
			#{brdid},
			#{repContent},
			NOW(),
			NOW(),
			#{userno}
		)
		<selectKey keyProperty="repid" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>	
	<select id="findEducationReply" parameterType="SchoolVO"  resultType="SchoolVO">
		SELECT 
			a.repid,
			b.nickname as replier,
			a.content as repContent,
			DATE_FORMAT(a.regdate, '%Y-%m-%d %H:%i:%s') as repRegdate,
			a.likes as repLikes,
			a.dislikes as repDislikes
		FROM brd_schoolwork_reply a
		LEFT JOIN info_userinfo b on a.userno = b.userno
		WHERE a.brdid = #{brdid}
	</select>
	<delete id="deleteEducationReply" parameterType="SchoolVO">
		DELETE FROM
			brd_schoolwork_reply
		WHERE brdid = #{brdid}
	</delete>
	<delete id="deleteEducation" parameterType="SchoolVO">
		DELETE FROM
			brd_schoolwork
		WHERE brdid=#{brdid}
	</delete>
	<update id="modEducationData" parameterType="SchoolVO">
		UPDATE brd_schoolwork SET
			content = #{content},
			title = #{title},
			moddate = NOW()
		WHERE brdid=#{brdid}
	</update>
	<update id="modEducationLikes" parameterType="SchoolVO">
		UPDATE brd_schoolwork SET
			likes = likes+1
		WHERE brdid=#{brdid}
	</update>
	<update id="modEducationDislikes" parameterType="SchoolVO">
		UPDATE brd_schoolwork SET
			dislikes = dislikes+1
		WHERE brdid=#{brdid}
	</update>
	<update id="modRepLikes" parameterType="BoardVO">
		UPDATE brd_schoolwork_reply SET
			likes = likes + 1
		WHERE repid = #{repid}
	</update>
	<update id="modRepDisLikes" parameterType="BoardVO">
		UPDATE brd_schoolwork_reply SET
			dislikes = dislikes+1
		WHERE repid = #{repid}
	</update>
</mapper>